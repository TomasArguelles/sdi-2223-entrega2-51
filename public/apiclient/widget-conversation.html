<div id="widget-detalles">
    <button onclick="widgetOffers()" class="btn">Volver</button>
    <div>
        <div class="media col-xs-10">
            <div>
                <h2>Conversaci√≥n:
                    <div>
                        <table class="table table-hover" id="table-messages">
                            <thead>
                            <tr>
                                <th>Autor</th>
                                <th>Mensaje</th>
                                <th>Leido</th>
                            </tr>
                            </thead>
                            <tbody id="messagesTableBody">

                            </tbody>
                        </table>
                    </div>
                </h2>

                <form class="media-body" method="post" encType="multipart/form-data">
                    <div class="form-group">
                        <label class="control-label col-sm-2" for="text">Mensaje:</label>
                        <div class="col-sm-10">
                            <input id="text" type="text" class="form-control" name="text" placeholder="Mensaje"
                                   required="true"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                            <button id="send-button" type="button" onclick="addMessages()" class="btn btn-primary">Enviar</button>
                        </div>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>
<script>

    loadAllMessages();

    function loadAllMessages(){

        $.ajax({
            url: URLbase + "/messages/" + idConver,
            type : "GET",
             // creo q aqui va el comprador
            dataType: 'json',
            headers: {
                "token" : token
            },
            success: function (response){
                messages = response.messages;
                updateMessages(messages);
                console.log(messages.length);
                console.log(messages);
            },error: function (error){
                clearInterval(refreshEachSecond);
                $("#main-container").load("widget-login.html");
            }
        });

    }

    function updateMessages(messages){

        $("#messagesTableBody").empty();
        if(messages.length === 0){
            $("#messagesTableBody").append(
                "<tr>" +
                "<td colspan='5'>No hay mensajes disponibles</td>" +
                "</tr>");
        }else{
            for(let i = 0; i<messages.length; i++){
                if(messages.idConver !== idConver) {
                    $("#messagesTableBody").append(
                        "<tr>" +
                        "<td>" + messages[i].idSender + "</td>" +
                        "<td>" + messages[i].texto + "</td>" +
                        "<td>" + messages[i].leido + "</td>" +
                        "</tr>"
                    )
                }
            }
        }
    }

    function addMessages(){

        $.ajax({
            url: URLbase + "/messages/add",
            type: "POST",
            data: {
                idConver: idConver,
                idOffer: selectedId,
                idSeller: seller,
                texto: $("#text").val(),
                offerTitle: title,
            },
            dataType: 'json',
            headers: {
                "token": token
            },
            success:  function (response) {

                $("#main-container").load("widget-offers.html");
                $("#text").val("");
            }, error: function (error) {
                clearInterval(refreshEachSecond);
                $("#main-container").load("widget-login.html");
            }
        })
    }

    var refreshEachSecond = window.setInterval(() => {
        updateMessages(messages);
    }, 1000);


</script>