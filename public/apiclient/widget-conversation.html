<div id="widget-detalles">
    <button onclick="widgetOffers()" class="btn">Volver</button>
    <div>
        <div class="media col-xs-10">
            <div>
                <h2>Conversaci√≥n:
                    <div>
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>Autor</th>
                                <th>Mensaje</th>
                                <th>Leido</th>
                            </tr>
                            </thead>
                            <tbody id="messagesTableBody">

                            </tbody>
                        </table>
                    </div>
                </h2>

                <form class="media-body" method="post" encType="multipart/form-data">
                    <div class="form-group">
                        <label class="control-label col-sm-2" for="msgBody">Mensaje:</label>
                        <div class="col-sm-10">
                            <input id="msgBody" type="text" class="form-control" name="msgBody" placeholder="Mensaje"
                                   required="true"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                            <button type="button" id="btnAdd" onclick="addMessages()" class="btn btn-primary">Enviar</button>
                        </div>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>
<script>
    window.history.pushState("", "", "/apiclient/client.html?w=singleConversation");
    //loadAllOfferMessages();


    function loadAllOfferMessages() {
        $.ajax({
            url: URLbase + "/messages/" + idConver,
            type : "GET",
            dataType: 'json',
            headers: {
                "token" : token
            },
            success: function (response){
                messages = response.messages;
                updateMessages(messages);
            },error: function (error){
                console.log("Error al cargar los mensajes. ", error);
                // clearInterval(refreshEachSecond);
                //$("#main-container").load("widget-login.html");
            }
        });
    }

    function updateMessages(messages){
        $("#messagesTableBody").empty();
        if(messages.length === 0){
            $("#messagesTableBody").append(
                "<tr>" +
                "<td colspan='5'>No hay mensajes disponibles</td>" +
                "</tr>");
        }else{
            for(let i = 0; i<messages.length; i++){
                $("#messagesTableBody").append(
                    "<tr>" +
                    "<td>" + messages[i].idSender + "</td>" +
                    "<td>" + messages[i].texto + "</td>" +
                    "<td>" + messages[i].leido + "</td>" +
                    "</tr>"
                )

            }
        }
    }

    function addMessages(){
        console.log($("#msgBody").val());
        $.ajax({
            url: URLbase + "/messages/add",
            type: "POST",
            data: {
                idConver: idConver,
                idOffer: offer._id,
                idSeller: offer.seller,
                texto: $("#msgBody").val(),
                offerTitle: offer.title,
            },
            dataType: 'json',
            headers: {
                "token": Cookies.get('token'),
                "content-type": "application/form-data"
            },
            success: function (response) {
                //loadAllOfferMessages();
                $("#msgBody").val("");
            }, error: function (error) {
                console.log("Error al enviar el mensaje. ", error);
                //clearInterval(refreshEachSecond);
                //$("#main-container").load("widget-login.html");
            }
        })
    }



</script>